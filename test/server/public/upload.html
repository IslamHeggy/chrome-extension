<!doctype html>
<html>
<head>
<meta http-equiv="Content-Type" charset="UTF-8" />
<title>Sending forms with FormData &ndash; MDN</title>
<script>
"use strict";

function ajaxSuccess () {
  console.log(this.responseText);
}

function AJAXSubmit () {
  var x = document.getElementById("fileInput");
  var txt = "";
  if ('files' in x) {
    if (x.files.length == 0) {
      txt = "Select one or more files.";
    } else {
      for (var i = 0; i < x.files.length; i++) {
        txt += "<br><strong>" + (i+1) + ". file</strong><br>";
        var file = x.files[i];
        if ('name' in file) {
          txt += "name: " + file.name + "<br>";
        }
        if ('size' in file) {
          txt += "size: " + file.size + " bytes <br>";
        }
      }
    }
  }


  var formData = new FormData();
  var fileInputElement = document.getElementById("fileInput");
   /*var reader = new FileReader();
    reader.onload = function(e) {
        // binary data
        console.log("Reader ready "+e.target.result);
    };
    reader.onerror = function(e) {
        // error occurred
        console.log('Reader Error : ' + e.type);
    };*/
    console.log("File data "+JSON.stringify(fileInputElement.files[0]));
    var theFile = fileInputElement.files[0].path;
    console.log('theFile = '+theFile)
    //var fileData = reader.readAsBinaryString(theFile);
    var fileData = load_binary_resource(theFile);
    console.log('fileData = '+fileData)
  formData.append("file", fileData,theFile.name);
  var request = new XMLHttpRequest();
  request.open("POST", "/upload");
  request.send(formData);
}

function load_binary_resource(url) {
  var byteArray = [];
  var req = new XMLHttpRequest();
  req.open('GET', url, false);
  req.overrideMimeType('text\/plain; charset=x-user-defined');
  req.send(null);
  if (req.status != 200) return byteArray;
  for (var i = 0; i < req.responseText.length; ++i) {
    byteArray.push(req.responseText.charCodeAt(i) & 0xff)
  }
  return byteArray;
}

function myFunction(){
  var x = document.getElementById("myFile");
  var txt = "";
  if ('files' in x) {
    if (x.files.length == 0) {
      txt = "Select one or more files.";
    } else {
      for (var i = 0; i < x.files.length; i++) {
        txt += "<br><strong>" + (i+1) + ". file</strong><br>";
        var file = x.files[i];
        console.log('file data ='+JSON.stringify(file));
        if ('name' in file) {
          txt += "name: " + file.name + "<br>";
        }
        if ('size' in file) {
          txt += "size: " + file.size + " bytes <br>";
        }
      }
    }
  }
  else {
    if (x.value == "") {
      txt += "Select one or more files.";
    } else {
      txt += "The files property is not supported by your browser!";
      txt  += "<br>The path of the selected file: " + x.value; // If the browser does not support the files property, it will return the path of the selected file instead.
    }
  }
  console.log(txt);
}

var fr;
var fileName;

function myFunction1(){
	event.preventDefault();
	console.log('<handleFileSelect> IN ');
	if (!window.File || !window.FileReader || !window.FileList || !window.Blob) {
		alert('The File APIs are not fully supported in this browser.');
		return;
	}

	var pan_id_media = document.getElementById('pan_id_media');
	var file;
	if (!pan_id_media) {
		alert("Choose a file first.");
	}
	else {
		if(pan_id_media && pan_id_media.files[0]){
			file = pan_id_media.files[0];
		}
		console.log('file = '+file);
		if(!file){
			alert("Choose a file first and Load again");
			return;
		}
		fileName = file.name;
		console.log('File Size '+file.size);
		if(file.size > 5000000){
			alert("Choose a file of size lesser than or equal to 5 MB");
			return;
		}


		console.log('fn_id_mediaile = '+pan_id_media);
		fr = new FileReader();
		fr.onload = galleryFileLoaded;
		fr.onloadstart = function(e) {
		}
		fr.readAsDataURL(file);
		console.log('<handleFileSelect> OUT ');
	}


}

function galleryFileLoaded(){
	var arrayBuffer = fr.result;
	var base64Data  = arrayBuffer;
	var commaIndex =  arrayBuffer.indexOf(',');
	base64Data = base64Data.substring(commaIndex+1,base64Data.length);
	console.log('gallery base64 File contents :'+base64Data);
	 var formData = new FormData();
	 const byteCharacters = atob(base64Data);
	  let blob = new Blob([base64Data], { type: "text/base64" });
	 formData.append("file", base64Data);
	 formData.append("name", fileName);
	 var request = new XMLHttpRequest();
     request.open("POST", "/upload");
     request.send(formData);
}

</script>
</head>
<body>

<h1>Upload files</h1>

<form action="/upload" method="post">
  <fieldset>
    <legend>Upload example</legend>
    <p>
      Post your files:
        <input type="file" id="pan_id_media" multiple size="50" onchange="myFunction1()">
      <!--<input type="file" name="file" id="fileInput" onchange="AJAXSubmit()">-->
    </p>
    <!--<p>
      <input type="submit" value="Submit" />
    </p>-->
  </fieldset>
</form>
</body>
</html>